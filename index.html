<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
   

  <title>Big Project: Rime Brika</title>

  <!-- Bootstrap Core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom Fonts -->
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="css/stylish-portfolio.min.css" rel="stylesheet">
  <link rel='manifest' href='./manifest.json'>
   <!-- Include Dexie -->
      <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>  
    <style>
        .listTemplate{display:none;}
        .movieTemplate{display:none;}
        .Completed {color:red;}
        .Open {color: green;}
        #header{
            background-color: #659DBD;
            color: white;
        }
        #sidebar-wrapper{
            background-color: #D1E8E2;
        }
        #list{
            background-color: #C38D9D;
            color: white;
        }
        #about{
            background-color: #E7717D;
            color: white;
        }
        .text-secondary{color: white;}
        a{color: white;}
        footer.footer .social-link {
            background-color:#AFD275;
        }
    </style>
</head>

<body id="page-top">

  <!-- Navigation -->
  <a class="menu-toggle rounded" href="#">
    <i class="fas fa-bars"></i>
  </a>
  <nav id="sidebar-wrapper">
    <ul class="sidebar-nav">
      <li class="sidebar-brand">
        <a class="js-scroll-trigger nav-main" href="#header">Graffiti Removal</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger nav-link" href="#search">Search</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger nav-link" href="#list">Restaurant</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger nav-link" href="#movie">Movie</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger nav-link" href="#map1">Map</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger nav-about" href="#about">About</a>
      </li>
    </ul>
  </nav>

  <!-- Header -->
  <section class="content-section bg-primary " id="header">
    <div class="container text-center my-auto">
      <h1 class="mb-1">Graffiti Removal Request</h1>
      <h3 class="mb-5">
        <em>A Progressive Web App to search through Graffiti Removal Requests</em><br>
          <em>Click on the nav bar icon to go to the search screen!</em>
      </h3>
    </div>
    <div class="overlay"></div>
  </section>

  <!-- About -->
    
  <section class="content-section bg-primary " id="about">
    <div class="container text-center my-auto">
      <h1 class="mb-1">Graffiti Removal App</h1>
      <h3 class="mb-5">
        <em>Developer: Rime Brika</em><br>
          <em>Bootstrap Template: Stylish Portfolio</em>
      </h3>
      <h3 >
        <p><a href="https://github.com/rbrika/it202-project2">GitHub Repo</a></p>
      </h3>
    </div>
      
    <div class="overlay"></div>
  </section>  
    
  <!-- Call to Action -->
  <section class="content-section bg-primary text-white" id="search">
    <div class="container text-center">
      <h2 class="mb-4">You can search for nearby resutrans and movies by using your current location. Click the button below to make the creach </h2>
        <form>
          <a href="#" class="btn btn-xl btn-dark" id="searchButton">Search</a>
        </form>
    </div>
  </section>

  <!-- List -->
  <section class="content-section bg-primary text-white text-center" id="list">
    <div class="container">
      <div class="content-section-heading">
        <h3 class="text-secondary mb-0" style="font-size:50px;">List</h3>
        <p id="show" class="mb-5" style="font-size:42px;"></p>
      </div>
      <div class="row" id="cardsList">
      </div>
    </div>
  </section>
    <div id="cardList"class="card listTemplate col-lg-3 col-md-6 mb-5 mb-lg-0"  data-id="">
		<div class="card-bodyList">
            <img src="">
			<h3 class="card-address mb-2 text-muted">Card title</h3>
			<h5 class="card-date mb-2 text-muted">Card date</h5>
            <h6 class="card-request mb-2 text-muted">Card date</h6>
            <h6 class="card-location mb-2 text-muted">Card date</h6>
            <h6 class="card-surface mb-2 text-muted">Card date</h6>
            <h6 class="card-status mb-2 text-muted">Card date</h6>
            <h6 class="card-dateComplete mb-2 text-muted">Card date</h6>
		</div>
	</div>
    
  <!-- Movie -->
  <section class="content-section bg-primary text-white text-center" id="movie">
    <div class="container">
      <div class="content-section-heading">
        <h3 class="text-secondary mb-0" style="font-size:50px;">List</h3>
        <p id="show" class="mb-5" style="font-size:42px;"></p>
      </div>
      <div class="row" id="cardsMovie">
      </div>
    </div>
  </section>
    <div id="cardMovie"class="card movieTemplate col-lg-3 col-md-6 mb-5 mb-lg-0"  data-id="">
		<div class="card-bodyMovie">
            <img src="">
			<h3 class="card-address mb-2 text-muted">Card title</h3>
			<h5 class="card-date mb-2 text-muted">Card date</h5>
            <h6 class="card-request mb-2 text-muted">Card date</h6>
		</div>
	</div>
    
  <!-- Map -->
  <section id="map1" class="map"></section>

  <!-- Footer -->
  <footer class="footer text-center">
    <div class="container">
      <ul class="list-inline mb-5">
       
        <li class="list-inline-item">
          <a class="social-link rounded-circle text-white" href="https://github.com/rbrika/it202-project2">
            <i class="icon-social-github"></i>
          </a>
        </li>
      </ul>
      <p class="text-muted small mb-0">Copyright &copy; Rime Brika Project 2 2019</p>
    </div>
  </footer>

  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded js-scroll-trigger" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Plugin JavaScript -->
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

  <!-- Custom scripts for this template -->
  <script src="js/stylish-portfolio.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
      

    <script>
        var lat;
        var long;
        function initMap(){
            var chicago = {lat: 41.8781, lng: -87.6298};
            var map = new google.maps.Map(document.getElementById('map1'), {zoom: 12, center: chicago}); 
        };
        var x = document.getElementById("demo");
      $(document).ready(function() {
          
         
          $("#map1").css("display",  "none");
          $("#search").css("display","none");
          $("#list").css("display",  "none");
          $("#movie").css("display", "none");
          $("#about").css("display", "none");
          var db = new Dexie("yelp_database");
          db.version(1).stores({
              yelp: '++id,name,address,city,state,zipcode,phone,rating,reviewcount,image,lat,long',
              movie:'++id,title,releaseDate,longDescription',
              showtime:'++id,title,theatre,dateTime',
              theatres:'theatre'
              
          });
          db.yelp.clear();
          function loadCards(){
                
                db.yelp.each(function(v){
                    var clone = $(".listTemplate").clone();
                    var x = document.createElement("IMG");
                      x.setAttribute("src", v.image);
                      x.setAttribute("width", "200");
                      x.setAttribute("height", "150");
                     clone.append(x);
                     clone.find(".card-address").text(v.name);
                     clone.find(".card-date").text("Date Created: "+v.address); 
                     clone.find(".card-request").text("Service Request Number: "+v.city); 
                     clone.find(".card-location").text("Where the Graffiti is located: "+v.state); 
                     clone.find(".card-status").text("Status: "+v.zipcode); 
                     clone.find(".card-surface").text("What type of surface?: "+v.phone); 
                     clone.find(".card-dateComplete").text("Completion Date: "+v.rating);
                     clone.attr("data-id",v.id);
                     clone.addClass(v.statusDB);
                     clone.removeClass("listTemplate");
                     $("#cardsList").append(clone);
                   
                });
                                   
          }
          function addMarkers(){
              var chicago = {lat: 41.8781, lng: -87.6298};
              var map = new google.maps.Map(document.getElementById('map1'), {zoom: 12, center: chicago}); 
              db.yelp.each(function(v){
                  console.log(v.id+" added marker");
                  var infowindow = new google.maps.InfoWindow({
                         content:
                          '<div id="content">'+
                              '<div id="siteNotice">'+
                              '</div>'+
                               '<h1 id="firstHeading" class="firstHeading">' 
                                +v.name+ 
                                '</h1>'+
                                '<div id="bodyContent">'+
                                '<b>Date Created: '+v.address+'<br>Completion Date:'+v.city+
                                '</b><br><br><b>Where the Graffiti is located: '+v.state+'</b><br><br><b>What type of surface?: '+v.zipcode+'</b>'+
                                '<br><br><b>Status: '+v.phone+'</b><br><br><b>Service Request Number: '+v.rating+'</b>'+
                                '</div>'+
                          '</div>'
                  });
                  
                  var iconColor="restaurant.png"
                  var location = {lat: v.lat, lng: v.long};
                  var marker = new google.maps.Marker({
                             position: location, 
                             map: map,
                             icon: "blue-dot.png"
                  });
                  
                  marker.set("id",v.id);
                  marker.addListener('click', function() {
                      var idM=marker.get("id");
                      console.log("clicked on marker "+idM);
                      infowindow.open(map, marker);
                  });
              });
              var id=0;
              db.theatres.each(function(v){
                  console.log(id+" Movie added marker");
                  var infowindow = new google.maps.InfoWindow({
                         content:
                          '<div id="content">'+
                              '<div id="siteNotice">'+
                              '</div>'+
                               '<h1 id="firstHeading" class="firstHeading">' 
                                +v.theatre+ 
                                '</h1>'+
                          '</div>'
                  });
                  var geocoder = new google.maps.Geocoder();
                   geocoder.geocode({
                      'address': v.theatre
                   }, 
                   function(results, status) {
                      if(status == google.maps.GeocoderStatus.OK) {
                         var marker=new google.maps.Marker({
                            position: results[0].geometry.location,
                            map: map
                          });
                          marker.set("id",id);
                          marker.addListener('click', function() {
                              var idM=marker.get("id");
                              console.log("clicked on marker "+idM);
                              infowindow.open(map, marker);
                          });
                      }
                       else{
                           console.log("Cant add marker for "+v.theatre);
                       }
                   });
                  id++;
              });
          }
          function loadMovieCards(){
             db.movie.each(function(v){
                    var clone = $(".movieTemplate").clone();
                     clone.find(".card-address").text(v.title);
                     clone.find(".card-date").text("Date Created: "+v.releaseDate); 
                     clone.find(".card-request").text("Service Request Number: "+v.longDescription);
                     clone.removeClass("movieTemplate");
                     $("#cardsMovie").append(clone);
                   
                });
          }
          function addMovieMarkers(){
              var chicago = {lat: lat, lng: long};
              var map = new google.maps.Map(document.getElementById('map1'), {zoom: 12, center: chicago}); 
              db.yelp.each(function(v){
                  console.log(v.id+" added marker");
                  var infowindow = new google.maps.InfoWindow({
                         content:
                          '<div id="content">'+
                              '<div id="siteNotice">'+
                              '</div>'+
                               '<h1 id="firstHeading" class="firstHeading">' 
                                +v.name+ 
                                '</h1>'+
                                '<div id="bodyContent">'+
                                '<b>Date Created: '+v.address+'<br>Completion Date:'+v.city+
                                '</b><br><br><b>Where the Graffiti is located: '+v.state+'</b><br><br><b>What type of surface?: '+v.zipcode+'</b>'+
                                '<br><br><b>Status: '+v.phone+'</b><br><br><b>Service Request Number: '+v.rating+'</b>'+
                                '</div>'+
                          '</div>'
                  });
                  
                  var iconColor="restaurant.png"
                  var location = {lat: v.lat, lng: v.long};
                  var marker = new google.maps.Marker({
                             position: location, 
                             map: map,
                             icon: iconColor
                  });
                  
                  marker.set("id",v.id);
                  marker.addListener('click', function() {
                      var idM=marker.get("id");
                      console.log("clicked on marker "+idM);
                      infowindow.open(map, marker);
                  });
              });
          }
         $(".nav-link").on("click", function(){
             hideScreens();
             console.log("clicked on nav content");
             var target = $(this).attr("href");
             $(target).css("display", "block");
             if(target=="#map1"){
                 console.log("Clicked on map");
               
                }
         }); 
         $(".nav-about").on("click",function(){
             hideScreens();
             $("#about").css("display", "block");
         });
         $(".nav-main").on("click",function(){
             db.yelp.clear();
             $("#cardsList").empty();
             $("#map1").empty();
             document.getElementById("show").innerHTML = "Showing 0 results:";
             hideScreens();
             console.log("clicked on Nav MEnu");
             $("#header").css("display", "block");
         });
         function hideScreens() {
             console.log("Hiding Screens");
             $("#map1").css("display", "none");
             $("#search").css("display", "none");
             $("#list").css("display", "none");
             $("#header").css("display", "none");
             $("#about").css("display", "none");
             
         }
         $("#searchButton").on("click", function(){
             db.yelp.clear();
             $("#cardsList").empty();
             $("#map1").empty();  
             getLocation();
             
         });
          function getLocation() {
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
              } else { 
                console.log("Geolocation is not supported by this browser.");
              }
          }
          function makeAjax(){
              var myurl = "https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?latitude="+lat+"&longitude="+long;
         $.ajax({
            url: myurl,
            headers: {
             'Authorization':'Bearer 8HMrAIZ_bA1azrlWFUB1J8WJ8z0EQEmro0Z3FZzsCyvzppZhxp8-px6_5XvK4Ttu05QOk0IxXEs8xlijmF7CV0CoGWbxAzJJ3jXIqcC9-fZHOyQzVl0hYr0cazG1XHYx',
         },
            method: 'GET',
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(data){
                
                // Grab the results from the API JSON return
                var totalresults = data.businesses.length;
                
                // If our results are greater than 0, continue
                if (totalresults > 0){
                    // Display a header on the page with the number of results
                    $('#header').append('<h5>We discovered ' + totalresults + ' results!</h5>');
                    // Itirate through the JSON array of 'businesses' which was returned by the API
                    $.each(data.businesses, function(i, item) {
                        // Store each business's object in a variable
                        db.yelp.put({
                             name:item.name,
                             address:item.location.address1,
                             city:item.location.city,
                             state:item.location.state,
                             zipcode:item.location.zip_code,
                             phone:item.display_phone,
                             rating:item.rating,
                             reviewcount:item.review_count,
                             image:item.image_url,
                             lat:item.coordinates.latitude,
                             long:item.coordinates.longitude
                         });
                  });
                    loadCards();
                    addMarkers();
                } else {
                    // If our results are 0; no businesses were returned by the JSON therefor we display on the page no results were found
                    $('#header').append('<h5>We discovered no results!</h5>');
                }
            }
         }); 
              var today = new Date();
                var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = today.getFullYear();

            today = yyyy + '-' + mm + '-' + dd;
            
              var url2='https://data.tmsapi.com/v1.1/movies/showings?startDate='+today+'&lat='+lat+'&lng='+long+'&api_key=cd62umkja4byk4g4y2j5cbsa';
                       $.ajax({
            url: url2,
            method: 'GET',
            dataType: 'json',
            success: function(data){
                
                //Grab the results from the API JSON return
                var totalresults = data.length;
                
                // If our results are greater than 0, continue
                if (totalresults > 0){
                    // Display a header on the page with the number of results
                    $('#header').append('<h5>We discovered ' + totalresults + ' results!</h5>');
                    // Itirate through the JSON array of 'businesses' which was returned by the API
                    $.each(data, function(i, item) {
                        // Store each business's object in a variable
                        db.movie.put({
                             title:item.title,
                             releaseDate:item.releaseDate,
                             longDescription:item.longDescription
                         });
                            $.each(item.showtimes,function(i,v){
                                   
                                db.showtime.put({
                                   name:item.title,
                                   theatre:v.theatre.name,
                                   dateTime:v.dateTime
                               });
                                db.theatres.put({theatre:v.theatre.name});

                            });
                  });
                     loadMovieCards();
                     addMarkers();
                } else {
                    // If our results are 0; no businesses were returned by the JSON therefor we display on the page no results were found
                    $('#header').append('<h5>We discovered no results!</h5>');
                }
            }
         }); 
    }
          function showPosition(position) {
            lat=position.coords.latitude;
            long=position.coords.longitude;
            console.log("Latitude: " + position.coords.latitude + 
              "<br>Longitude: " + position.coords.longitude);
            makeAjax();
        }
      });
        // register the service worker for offline use
        if('serviceWorker' in navigator) {
          navigator.serviceWorker
                   .register('./sw.js')
                   .then(function() { 
                          console.log("Service Worker Registered");   
                   });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyCdVEsFVj2iW8PweCj3hm8BkBRlz2qbTgM&callback=initMap">
    </script>

</body>
</html>
